name: 简单测试

on:
  workflow_dispatch:

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - name: 检出代码
        uses: actions/checkout@v4

      - name: 设置 Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: 安装 requests
        run: pip install requests

      - name: 检查 Secrets
        env:
          TAVILY_API_KEY: ${{ secrets.TAVILY_API_KEY }}
          FEISHU_WEBHOOK_URL: ${{ secrets.FEISHU_WEBHOOK_URL }}
        run: |
          echo "检查 Secrets..."
          if [ -z "$TAVILY_API_KEY" ]; then
            echo "❌ TAVILY_API_KEY 未设置"
            exit 1
          fi
          if [ -z "$FEISHU_WEBHOOK_URL" ]; then
            echo "❌ FEISHU_WEBHOOK_URL 未设置"
            exit 1
          fi
          echo "✅ Secrets 配置正确"

      - name: 列出 Python 文件
        run: ls -la *.py

      - name: 测试模块导入
        run: |
          python3 -c "from weather_monitor import format_weather_report; print('✅ weather_monitor OK')"
          python3 -c "from news_monitor import format_news_report; print('✅ news_monitor OK')"
          python3 -c "from feishu_sender import FeishuSender; print('✅ feishu_sender OK')"
          python3 -c "from storage import NewsStorage; print('✅ storage OK')"

      - name: 测试飞书推送
        env:
          FEISHU_WEBHOOK_URL: ${{ secrets.FEISHU_WEBHOOK_URL }}
        run: |
          python3 -c "import requests; import os; webhook=os.environ['FEISHU_WEBHOOK_URL']; r=requests.post(webhook, json={'msg_type':'text','content':{'text':'GitHub Actions 测试'}}); print('✅ 推送成功' if r.status_code==200 else f'❌ 失败: {r.status_code}')"
