name: ç®€åŒ–æµ‹è¯•

on:
  workflow_dispatch:

jobs:
  test:
    name: ç®€åŒ–æµ‹è¯•
    runs-on: ubuntu-latest

    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: è®¾ç½® Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: å®‰è£…ä¾èµ–
        run: |
          pip install requests

      - name: æµ‹è¯•ç¯å¢ƒå˜é‡
        env:
          TAVILY_API_KEY: ${{ secrets.TAVILY_API_KEY }}
          FEISHU_WEBHOOK_URL: ${{ secrets.FEISHU_WEBHOOK_URL }}
        run: |
          echo "æ£€æŸ¥ç¯å¢ƒå˜é‡..."
          if [ -z "$TAVILY_API_KEY" ]; then
            echo "âŒ TAVILY_API_KEY æœªè®¾ç½®"
          else
            echo "âœ… TAVILY_API_KEY å·²è®¾ç½®: ${TAVILY_API_KEY:0:10}..."
          fi

          if [ -z "$FEISHU_WEBHOOK_URL" ]; then
            echo "âŒ FEISHU_WEBHOOK_URL æœªè®¾ç½®"
          else
            echo "âœ… FEISHU_WEBHOOK_URL å·²è®¾ç½®"
          fi

      - name: åˆ—å‡ºæ–‡ä»¶
        run: |
          echo "é¡¹ç›®æ–‡ä»¶ï¼š"
          ls -la *.py | head -20

      - name: æµ‹è¯• Python è„šæœ¬
        env:
          TAVILY_API_KEY: ${{ secrets.TAVILY_API_KEY }}
          FEISHU_WEBHOOK_URL: ${{ secrets.FEISHU_WEBHOOK_URL }}
        run: |
          python --version
          echo "æµ‹è¯•å¯¼å…¥æ¨¡å—..."
          python -c "from weather_monitor import format_weather_report; print('âœ… weather_monitor å¯¼å…¥æˆåŠŸ')"
          python -c "from news_monitor import format_news_report; print('âœ… news_monitor å¯¼å…¥æˆåŠŸ')"
          python -c "from feishu_sender import FeishuSender; print('âœ… feishu_sender å¯¼å…¥æˆåŠŸ')"
          python -c "from storage import NewsStorage; print('âœ… storage å¯¼å…¥æˆåŠŸ')"

      - name: æµ‹è¯•é£ä¹¦æ¨é€
        env:
          FEISHU_WEBHOOK_URL: ${{ secrets.FEISHU_WEBHOOK_URL }}
        run: |
          python3 << 'PYEOF'
import requests
import os

webhook_url = os.environ.get('FEISHU_WEBHOOK_URL')
print(f"Webhook URL: {webhook_url[:50]}...")

data = {
    "msg_type": "text",
    "content": {
        "text": "ğŸ‰ GitHub Actions æµ‹è¯•æˆåŠŸï¼è¿™æ˜¯æ¥è‡ªç®€åŒ–æµ‹è¯•çš„æ¶ˆæ¯ã€‚"
    }
}

try:
    response = requests.post(webhook_url, json=data, timeout=10)
    if response.status_code == 200:
        print("âœ… é£ä¹¦æ¨é€æµ‹è¯•æˆåŠŸ")
    else:
        print(f"âŒ é£ä¹¦æ¨é€å¤±è´¥: {response.status_code}")
except Exception as e:
    print(f"âŒ å¼‚å¸¸: {e}")
PYEOF
