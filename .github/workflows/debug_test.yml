name: è°ƒè¯•æµ‹è¯•

on:
  workflow_dispatch:

jobs:
  debug:
    name: è°ƒè¯•æµ‹è¯•
    runs-on: ubuntu-latest

    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: æ£€æŸ¥ Secrets
        env:
          TAVILY_API_KEY: ${{ secrets.TAVILY_API_KEY }}
          FEISHU_WEBHOOK_URL: ${{ secrets.FEISHU_WEBHOOK_URL }}
        run: |
          echo "=== æ£€æŸ¥ç¯å¢ƒå˜é‡ ==="
          if [ -z "$TAVILY_API_KEY" ]; then
            echo "âŒ TAVILY_API_KEY æœªè®¾ç½®"
            exit 1
          else
            echo "âœ… TAVILY_API_KEY å·²è®¾ç½®: ${TAVILY_API_KEY:0:15}..."
          fi

          if [ -z "$FEISHU_WEBHOOK_URL" ]; then
            echo "âŒ FEISHU_WEBHOOK_URL æœªè®¾ç½®"
            exit 1
          else
            echo "âœ… FEISHU_WEBHOOK_URL å·²è®¾ç½®: ${FEISHU_WEBHOOK_URL:0:40}..."
          fi

      - name: æ£€æŸ¥æ–‡ä»¶
        run: |
          echo "=== æ£€æŸ¥é¡¹ç›®æ–‡ä»¶ ==="
          ls -la *.py 2>/dev/null | head -10 || echo "âŒ æ²¡æœ‰ Python æ–‡ä»¶"
          echo ""
          echo "=== æ£€æŸ¥å…³é”®æ–‡ä»¶ ==="
          for file in logistics_alert_github.py weather_monitor.py news_monitor.py feishu_sender.py storage.py; do
            if [ -f "$file" ]; then
              echo "âœ… $file å­˜åœ¨"
            else
              echo "âŒ $file ä¸å­˜åœ¨"
            fi
          done

      - name: æµ‹è¯•é£ä¹¦æ¨é€
        env:
          FEISHU_WEBHOOK_URL: ${{ secrets.FEISHU_WEBHOOK_URL }}
        run: |
          echo "=== æµ‹è¯•é£ä¹¦æ¨é€ ==="
          pip install requests
          python3 << 'EOF'
import requests
import os

webhook_url = os.environ.get('FEISHU_WEBHOOK_URL')
print(f"Webhook URL: {webhook_url[:50]}...")

data = {
    "msg_type": "text",
    "content": {
        "text": "ğŸ‰ GitHub Actions è°ƒè¯•æµ‹è¯•æˆåŠŸï¼\n\nè¿™æ˜¯ä¸€æ¡æ¥è‡ª GitHub Actions çš„æµ‹è¯•æ¶ˆæ¯ã€‚"
    }
}

try:
    response = requests.post(webhook_url, json=data, timeout=10)
    if response.status_code == 200:
        print("âœ… é£ä¹¦æ¨é€æµ‹è¯•æˆåŠŸ")
    else:
        print(f"âŒ é£ä¹¦æ¨é€å¤±è´¥: {response.status_code}")
        print(f"å“åº”: {response.text}")
except Exception as e:
    print(f"âŒ å¼‚å¸¸: {e}")
EOF
